{
  "id": "school--cscc69--ostep--part-2-concurrency--28-locks",
  "path": "school/cscc69/ostep/part-2-concurrency/28-locks",
  "title": "28. Locks",
  "content": "**A variable that holds a state-either unlocked or locked (it holds more information, of course, but as users we only need to care about this).**\n### Evaluating Locks\n\nWe should care about three things when evaluating implementation of a lock:\n1. Does it provide mutual exclusion\n2. Does each thread contending for the lock get a fair shot at acquiring it once it's free? No thread should starve while waiting to obtain a lock.\n3. Is it performant?\n### Supporting Hardware\n\n##### test-and-set\n\nThe simplest bit of hardware support to understand is known as a **test-and-set (or atomic exchange)** instruction. \n- It is the locked version of the atomic exchange (`xchg`) on `x86`\n\nThe **test-and-set** instr. `TestAndSet(int *old_ptr, int new)` returns the old value pointed to by the `old_ptr` and updates it to `new`\n- Why does this work but a simple sequence of swaps or loads doesn't?\n\t- Everything is performed **atomically**!\n##### compare-and-swap\n\nAnother hardware primitive is the **compare-and-swap** instruction (called **compare-and-exchange** on `x86`) \n\n`CompareAndSwap(&lock->flag, 0, 1)` tests whether the value at the address specified by ptr is equal to expected; if so, update the memory location pointed to by ptr with the new value. Always return the original value at that memory location.\n##### fetch-and-add\n\nAutomatically increment a value while returning the old value at a particular address.\n## yield\n\nSo we don't waste CPU clock cycles with code like this:\n\n```C\nvoid lock() { \n\twhile (TestAndSet(&flag, 1) == 1) \n\t\t// spin\n}\n```\n\nRecall that a thread can either be running, ready or blocked. `yield()` is a system-call that moves us **running** to **ready**: the yielding thread **deschedules** itself.\n\nThis isn't perfect though so we can waste lots of time context-switching until we find the context that actually holds the lock.\n### Support from the OS\n\n##### Futex on Linux\n\nTODO!\n\n\n",
  "metadata": {
    "date": "2026-01-18",
    "updated": "2026-01-18"
  },
  "images": [],
  "links": []
}